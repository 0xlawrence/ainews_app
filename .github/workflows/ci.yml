name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run linting with ruff
      run: |
        pip install ruff
        ruff check src/ tests/
    
    - name: Run formatting check with black
      run: |
        pip install black
        black --check src/ tests/
    
    - name: Run type checking with mypy
      run: |
        pip install mypy
        mypy src/ --ignore-missing-imports
      continue-on-error: true  # Allow type errors for now during refactoring
    
    - name: Run tests with coverage
      run: |
        pytest --cov=src --cov-report=xml --cov-report=term-missing
      env:
        # Use mock API keys for testing
        OPENAI_API_KEY: "test-key"
        GEMINI_API_KEY: "test-key"
        CLAUDE_API_KEY: "test-key"
        SUPABASE_URL: "https://test.supabase.co"
        SUPABASE_KEY: "test-key"
    
    - name: Run PRD compliance tests
      run: |
        # Run basic PRD compliance checks without full newsletter generation
        python tests/test_prd_compliance.py
      continue-on-error: true  # Allow to pass during development
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        fail_ci_if_error: false  # Don't fail CI if codecov fails
    
    - name: Check coverage threshold
      run: |
        python -c "
        import xml.etree.ElementTree as ET
        tree = ET.parse('coverage.xml')
        coverage = float(tree.getroot().attrib['line-rate']) * 100
        print(f'Current coverage: {coverage:.2f}%')
        if coverage < 40:
            print('Coverage below 40% threshold!')
            exit(1)
        else:
            print('Coverage threshold met!')
        "

  newsletter-generation:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        playwright install chromium
    
    - name: Generate daily newsletter
      run: |
        python main.py --max-items 30 --edition daily --output-dir drafts/
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
    
    - name: Commit and push newsletter
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add drafts/
        git commit -m "ðŸ¤– Daily newsletter generated $(date)" || exit 0
        git push